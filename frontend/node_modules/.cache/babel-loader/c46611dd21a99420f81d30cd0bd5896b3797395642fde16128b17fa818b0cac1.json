{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\amy gee\\\\Desktop\\\\Sweet Bite Bakery System\\\\frontend\\\\src\\\\context\\\\AuthContext.js\",\n  _s = $RefreshSig$(),\n  _s2 = $RefreshSig$();\nimport React, { createContext, useContext, useState, useEffect, useCallback } from \"react\";\nimport api from \"../api/api\";\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst AuthContext = /*#__PURE__*/createContext();\n\n// -------------------------------------------------------\n//  ROLE NORMALIZER (ENSURES consistent customer/admin)\n// -------------------------------------------------------\nconst normalizeUser = rawUser => {\n  if (!rawUser) return null;\n  const rawRole = rawUser.role || rawUser.user_role || rawUser.role_name || rawUser.userType || \"\";\n  const normalizedRole = (rawRole || \"\").toLowerCase() === \"admin\" ? \"admin\" : \"customer\";\n  return {\n    ...rawUser,\n    role: normalizedRole\n  };\n};\nexport function AuthProvider({\n  children\n}) {\n  _s();\n  const [user, setUser] = useState(null);\n  const [loading, setLoading] = useState(true);\n\n  // -------------------------------------------------------\n  //  SAFE USER SETTER (SYNC LOCALSTORAGE + STATE)\n  // -------------------------------------------------------\n  const updateUser = useCallback(updatedUser => {\n    const normalized = normalizeUser(updatedUser);\n    if (!normalized) return;\n    localStorage.setItem(\"user\", JSON.stringify(normalized));\n    setUser(normalized); // üî• triggers UI re-render instantly\n  }, []);\n\n  // -------------------------------------------------------\n  //  LOAD USER + TOKEN ON APP START\n  // -------------------------------------------------------\n  useEffect(() => {\n    const bootstrapAuth = async () => {\n      try {\n        const storedUser = localStorage.getItem(\"user\");\n        const token = localStorage.getItem(\"token\");\n        if (storedUser && token) {\n          api.defaults.headers.common[\"Authorization\"] = `Bearer ${token}`;\n\n          // Validate token against backend to avoid stale sessions\n          try {\n            const res = await api.get(\"/user\");\n            const freshUser = normalizeUser(res.data.user || res.data);\n            if (freshUser) {\n              updateUser(freshUser);\n            } else {\n              throw new Error(\"Invalid user payload\");\n            }\n          } catch (err) {\n            var _err$response;\n            // If backend is down (500) keep the cached user so the UI can still render\n            const parsedUser = normalizeUser(JSON.parse(storedUser));\n            const status = err === null || err === void 0 ? void 0 : (_err$response = err.response) === null || _err$response === void 0 ? void 0 : _err$response.status;\n            console.warn(\"Token validation failed:\", status, err === null || err === void 0 ? void 0 : err.message);\n            if (status === 401) {\n              // Invalid token ‚Äî clear session\n              localStorage.removeItem(\"user\");\n              localStorage.removeItem(\"token\");\n              delete api.defaults.headers.common[\"Authorization\"];\n              setUser(null);\n            } else {\n              // Keep cached user for non-auth errors (e.g., 500)\n              setUser(parsedUser);\n            }\n          }\n        }\n      } catch (err) {\n        console.warn(\"üö® Corrupted localStorage user:\", err);\n        localStorage.removeItem(\"user\");\n        localStorage.removeItem(\"token\");\n      } finally {\n        setLoading(false);\n      }\n    };\n    bootstrapAuth();\n  }, [updateUser]);\n\n  // -------------------------------------------------------\n  //  LOGIN (NOW FETCHES FRESH USER DATA)\n  // -------------------------------------------------------\n  async function login(email, password) {\n    const response = await api.post(\"/login\", {\n      email,\n      password\n    });\n    const userData = normalizeUser(response.data.user || response.data.data);\n    const token = response.data.token;\n    console.log(\"Login response:\", {\n      user: userData,\n      token: token,\n      role: userData === null || userData === void 0 ? void 0 : userData.role\n    });\n    if (!userData || !token) {\n      throw new Error(\"Invalid login response: missing user or token\");\n    }\n\n    // Ensure role is present\n    if (!(userData !== null && userData !== void 0 && userData.role)) {\n      console.warn(\"‚ö†Ô∏è Warning: User role not provided in login response\");\n    }\n\n    // Store in localStorage\n    localStorage.setItem(\"user\", JSON.stringify(userData));\n    localStorage.setItem(\"token\", token);\n\n    // Update state\n    setUser(userData);\n    console.log(\"‚úÖ Login successful. User role:\", userData.role);\n    return userData;\n  }\n\n  // -------------------------------------------------------\n  //  LOGOUT\n  // -------------------------------------------------------\n  async function logout() {\n    try {\n      await api.post(\"/logout\");\n    } catch (err) {\n      console.error(\"Logout API call failed:\", err);\n    } finally {\n      localStorage.removeItem(\"user\");\n      localStorage.removeItem(\"token\");\n      setUser(null);\n      console.log(\"‚úÖ Logged out successfully\");\n    }\n  }\n\n  // -------------------------------------------------------\n  //  REFRESH USER DATA FROM BACKEND\n  //  (Used after updating profile)\n  // -------------------------------------------------------\n  async function refreshUser() {\n    try {\n      const token = localStorage.getItem(\"token\");\n      if (!token) return;\n      const response = await api.get(\"/user\", {\n        headers: {\n          Authorization: `Bearer ${token}`\n        }\n      });\n      updateUser(response.data.user || response.data);\n    } catch (err) {\n      console.warn(\"Failed to refresh user:\", err);\n    }\n  }\n  return /*#__PURE__*/_jsxDEV(AuthContext.Provider, {\n    value: {\n      user,\n      setUser: updateUser,\n      // üî• used by Profile.js\n      login,\n      logout,\n      refreshUser,\n      // üî• call this after saving profile\n      loading\n    },\n    children: !loading && children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 157,\n    columnNumber: 5\n  }, this);\n}\n_s(AuthProvider, \"HKylofj/2dCtKykaYy3kw2JwNfw=\");\n_c = AuthProvider;\nexport function useAuth() {\n  _s2();\n  return useContext(AuthContext);\n}\n_s2(useAuth, \"gDsCjeeItUuvgOWf1v4qoK9RF6k=\");\nvar _c;\n$RefreshReg$(_c, \"AuthProvider\");","map":{"version":3,"names":["React","createContext","useContext","useState","useEffect","useCallback","api","jsxDEV","_jsxDEV","AuthContext","normalizeUser","rawUser","rawRole","role","user_role","role_name","userType","normalizedRole","toLowerCase","AuthProvider","children","_s","user","setUser","loading","setLoading","updateUser","updatedUser","normalized","localStorage","setItem","JSON","stringify","bootstrapAuth","storedUser","getItem","token","defaults","headers","common","res","get","freshUser","data","Error","err","_err$response","parsedUser","parse","status","response","console","warn","message","removeItem","login","email","password","post","userData","log","logout","error","refreshUser","Authorization","Provider","value","fileName","_jsxFileName","lineNumber","columnNumber","_c","useAuth","_s2","$RefreshReg$"],"sources":["C:/Users/amy gee/Desktop/Sweet Bite Bakery System/frontend/src/context/AuthContext.js"],"sourcesContent":["import React, { createContext, useContext, useState, useEffect, useCallback } from \"react\";\nimport api from \"../api/api\";\n\nconst AuthContext = createContext();\n\n// -------------------------------------------------------\n//  ROLE NORMALIZER (ENSURES consistent customer/admin)\n// -------------------------------------------------------\nconst normalizeUser = (rawUser) => {\n  if (!rawUser) return null;\n  const rawRole =\n    rawUser.role ||\n    rawUser.user_role ||\n    rawUser.role_name ||\n    rawUser.userType ||\n    \"\";\n  const normalizedRole = (rawRole || \"\").toLowerCase() === \"admin\" ? \"admin\" : \"customer\";\n  return { ...rawUser, role: normalizedRole };\n};\n\nexport function AuthProvider({ children }) {\n  const [user, setUser] = useState(null);\n  const [loading, setLoading] = useState(true);\n\n  // -------------------------------------------------------\n  //  SAFE USER SETTER (SYNC LOCALSTORAGE + STATE)\n  // -------------------------------------------------------\n  const updateUser = useCallback((updatedUser) => {\n    const normalized = normalizeUser(updatedUser);\n    if (!normalized) return;\n    localStorage.setItem(\"user\", JSON.stringify(normalized));\n    setUser(normalized); // üî• triggers UI re-render instantly\n  }, []);\n\n  // -------------------------------------------------------\n  //  LOAD USER + TOKEN ON APP START\n  // -------------------------------------------------------\n  useEffect(() => {\n    const bootstrapAuth = async () => {\n      try {\n        const storedUser = localStorage.getItem(\"user\");\n        const token = localStorage.getItem(\"token\");\n\n        if (storedUser && token) {\n          api.defaults.headers.common[\"Authorization\"] = `Bearer ${token}`;\n\n          // Validate token against backend to avoid stale sessions\n          try {\n            const res = await api.get(\"/user\");\n            const freshUser = normalizeUser(res.data.user || res.data);\n            if (freshUser) {\n              updateUser(freshUser);\n            } else {\n              throw new Error(\"Invalid user payload\");\n            }\n          } catch (err) {\n            // If backend is down (500) keep the cached user so the UI can still render\n            const parsedUser = normalizeUser(JSON.parse(storedUser));\n            const status = err?.response?.status;\n            console.warn(\"Token validation failed:\", status, err?.message);\n\n            if (status === 401) {\n              // Invalid token ‚Äî clear session\n              localStorage.removeItem(\"user\");\n              localStorage.removeItem(\"token\");\n              delete api.defaults.headers.common[\"Authorization\"];\n              setUser(null);\n            } else {\n              // Keep cached user for non-auth errors (e.g., 500)\n              setUser(parsedUser);\n            }\n          }\n        }\n      } catch (err) {\n        console.warn(\"üö® Corrupted localStorage user:\", err);\n        localStorage.removeItem(\"user\");\n        localStorage.removeItem(\"token\");\n      } finally {\n        setLoading(false);\n      }\n    };\n\n    bootstrapAuth();\n  }, [updateUser]);\n\n  // -------------------------------------------------------\n  //  LOGIN (NOW FETCHES FRESH USER DATA)\n  // -------------------------------------------------------\n  async function login(email, password) {\n    const response = await api.post(\"/login\", { email, password });\n\n    const userData = normalizeUser(response.data.user || response.data.data);\n    const token = response.data.token;\n\n    console.log(\"Login response:\", {\n      user: userData,\n      token: token,\n      role: userData?.role,\n    });\n\n    if (!userData || !token) {\n      throw new Error(\"Invalid login response: missing user or token\");\n    }\n\n    // Ensure role is present\n    if (!userData?.role) {\n      console.warn(\"‚ö†Ô∏è Warning: User role not provided in login response\");\n    }\n\n    // Store in localStorage\n    localStorage.setItem(\"user\", JSON.stringify(userData));\n    localStorage.setItem(\"token\", token);\n\n    // Update state\n    setUser(userData);\n\n    console.log(\"‚úÖ Login successful. User role:\", userData.role);\n    return userData;\n  }\n\n  // -------------------------------------------------------\n  //  LOGOUT\n  // -------------------------------------------------------\n  async function logout() {\n    try {\n      await api.post(\"/logout\");\n    } catch (err) {\n      console.error(\"Logout API call failed:\", err);\n    } finally {\n      localStorage.removeItem(\"user\");\n      localStorage.removeItem(\"token\");\n      setUser(null);\n      console.log(\"‚úÖ Logged out successfully\");\n    }\n  }\n\n  // -------------------------------------------------------\n  //  REFRESH USER DATA FROM BACKEND\n  //  (Used after updating profile)\n  // -------------------------------------------------------\n  async function refreshUser() {\n    try {\n      const token = localStorage.getItem(\"token\");\n      if (!token) return;\n\n      const response = await api.get(\"/user\", {\n        headers: { Authorization: `Bearer ${token}` },\n      });\n\n      updateUser(response.data.user || response.data);\n    } catch (err) {\n      console.warn(\"Failed to refresh user:\", err);\n    }\n  }\n\n  return (\n    <AuthContext.Provider\n      value={{\n        user,\n        setUser: updateUser, // üî• used by Profile.js\n        login,\n        logout,\n        refreshUser, // üî• call this after saving profile\n        loading,\n      }}\n    >\n      {!loading && children}\n    </AuthContext.Provider>\n  );\n}\n\nexport function useAuth() {\n  return useContext(AuthContext);\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}