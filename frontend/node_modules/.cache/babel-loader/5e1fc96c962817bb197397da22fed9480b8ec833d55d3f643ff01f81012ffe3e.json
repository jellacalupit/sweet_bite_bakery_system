{"ast":null,"code":"import _objectSpread from\"C:/Users/amy gee/Desktop/Sweet Bite Bakery System/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{createContext,useContext,useState,useEffect,useCallback}from\"react\";import api from\"../api/api\";import{jsx as _jsx}from\"react/jsx-runtime\";const AuthContext=/*#__PURE__*/createContext();// -------------------------------------------------------\n//  ROLE NORMALIZER (ENSURES consistent customer/admin)\n// -------------------------------------------------------\nconst normalizeUser=rawUser=>{if(!rawUser)return null;const rawRole=rawUser.role||rawUser.user_role||rawUser.role_name||rawUser.userType||\"\";const normalizedRole=(rawRole||\"\").toLowerCase()===\"admin\"?\"admin\":\"customer\";return _objectSpread(_objectSpread({},rawUser),{},{role:normalizedRole});};export function AuthProvider(_ref){let{children}=_ref;const[user,setUser]=useState(null);const[loading,setLoading]=useState(true);// -------------------------------------------------------\n//  SAFE USER SETTER (SYNC LOCALSTORAGE + STATE)\n// -------------------------------------------------------\nconst updateUser=useCallback(updatedUser=>{const normalized=normalizeUser(updatedUser);if(!normalized)return;localStorage.setItem(\"user\",JSON.stringify(normalized));setUser(normalized);// üî• triggers UI re-render instantly\n},[]);// -------------------------------------------------------\n//  LOAD USER + TOKEN ON APP START\n// -------------------------------------------------------\nuseEffect(()=>{const bootstrapAuth=async()=>{try{const storedUser=localStorage.getItem(\"user\");const token=localStorage.getItem(\"token\");if(storedUser&&token){api.defaults.headers.common[\"Authorization\"]=\"Bearer \".concat(token);// Validate token against backend to avoid stale sessions\ntry{const res=await api.get(\"/user\");const freshUser=normalizeUser(res.data.user||res.data);if(freshUser){updateUser(freshUser);}else{throw new Error(\"Invalid user payload\");}}catch(err){var _err$response;// If backend is down (500) keep the cached user so the UI can still render\nconst parsedUser=normalizeUser(JSON.parse(storedUser));const status=err===null||err===void 0?void 0:(_err$response=err.response)===null||_err$response===void 0?void 0:_err$response.status;console.warn(\"Token validation failed:\",status,err===null||err===void 0?void 0:err.message);if(status===401){// Invalid token ‚Äî clear session\nlocalStorage.removeItem(\"user\");localStorage.removeItem(\"token\");delete api.defaults.headers.common[\"Authorization\"];setUser(null);}else{// Keep cached user for non-auth errors (e.g., 500)\nsetUser(parsedUser);}}}}catch(err){console.warn(\"üö® Corrupted localStorage user:\",err);localStorage.removeItem(\"user\");localStorage.removeItem(\"token\");}finally{setLoading(false);}};bootstrapAuth();},[updateUser]);// -------------------------------------------------------\n//  LOGIN (NOW FETCHES FRESH USER DATA)\n// -------------------------------------------------------\nasync function login(email,password){const response=await api.post(\"/login\",{email,password});const userData=normalizeUser(response.data.user||response.data.data);const token=response.data.token;console.log(\"Login response:\",{user:userData,token:token,role:userData===null||userData===void 0?void 0:userData.role});if(!userData||!token){throw new Error(\"Invalid login response: missing user or token\");}// Ensure role is present\nif(!(userData!==null&&userData!==void 0&&userData.role)){console.warn(\"‚ö†Ô∏è Warning: User role not provided in login response\");}// Store in localStorage\nlocalStorage.setItem(\"user\",JSON.stringify(userData));localStorage.setItem(\"token\",token);// Update state\nsetUser(userData);console.log(\"‚úÖ Login successful. User role:\",userData.role);return userData;}// -------------------------------------------------------\n//  LOGOUT\n// -------------------------------------------------------\nasync function logout(){try{await api.post(\"/logout\");}catch(err){console.error(\"Logout API call failed:\",err);}finally{localStorage.removeItem(\"user\");localStorage.removeItem(\"token\");setUser(null);console.log(\"‚úÖ Logged out successfully\");}}// -------------------------------------------------------\n//  REFRESH USER DATA FROM BACKEND\n//  (Used after updating profile)\n// -------------------------------------------------------\nasync function refreshUser(){try{const token=localStorage.getItem(\"token\");if(!token)return;const response=await api.get(\"/user\",{headers:{Authorization:\"Bearer \".concat(token)}});updateUser(response.data.user||response.data);}catch(err){console.warn(\"Failed to refresh user:\",err);}}return/*#__PURE__*/_jsx(AuthContext.Provider,{value:{user,setUser:updateUser,// üî• used by Profile.js\nlogin,logout,refreshUser,// üî• call this after saving profile\nloading},children:!loading&&children});}export function useAuth(){return useContext(AuthContext);}","map":{"version":3,"names":["React","createContext","useContext","useState","useEffect","useCallback","api","jsx","_jsx","AuthContext","normalizeUser","rawUser","rawRole","role","user_role","role_name","userType","normalizedRole","toLowerCase","_objectSpread","AuthProvider","_ref","children","user","setUser","loading","setLoading","updateUser","updatedUser","normalized","localStorage","setItem","JSON","stringify","bootstrapAuth","storedUser","getItem","token","defaults","headers","common","concat","res","get","freshUser","data","Error","err","_err$response","parsedUser","parse","status","response","console","warn","message","removeItem","login","email","password","post","userData","log","logout","error","refreshUser","Authorization","Provider","value","useAuth"],"sources":["C:/Users/amy gee/Desktop/Sweet Bite Bakery System/frontend/src/context/AuthContext.js"],"sourcesContent":["import React, { createContext, useContext, useState, useEffect, useCallback } from \"react\";\nimport api from \"../api/api\";\n\nconst AuthContext = createContext();\n\n// -------------------------------------------------------\n//  ROLE NORMALIZER (ENSURES consistent customer/admin)\n// -------------------------------------------------------\nconst normalizeUser = (rawUser) => {\n  if (!rawUser) return null;\n  const rawRole =\n    rawUser.role ||\n    rawUser.user_role ||\n    rawUser.role_name ||\n    rawUser.userType ||\n    \"\";\n  const normalizedRole = (rawRole || \"\").toLowerCase() === \"admin\" ? \"admin\" : \"customer\";\n  return { ...rawUser, role: normalizedRole };\n};\n\nexport function AuthProvider({ children }) {\n  const [user, setUser] = useState(null);\n  const [loading, setLoading] = useState(true);\n\n  // -------------------------------------------------------\n  //  SAFE USER SETTER (SYNC LOCALSTORAGE + STATE)\n  // -------------------------------------------------------\n  const updateUser = useCallback((updatedUser) => {\n    const normalized = normalizeUser(updatedUser);\n    if (!normalized) return;\n    localStorage.setItem(\"user\", JSON.stringify(normalized));\n    setUser(normalized); // üî• triggers UI re-render instantly\n  }, []);\n\n  // -------------------------------------------------------\n  //  LOAD USER + TOKEN ON APP START\n  // -------------------------------------------------------\n  useEffect(() => {\n    const bootstrapAuth = async () => {\n      try {\n        const storedUser = localStorage.getItem(\"user\");\n        const token = localStorage.getItem(\"token\");\n\n        if (storedUser && token) {\n          api.defaults.headers.common[\"Authorization\"] = `Bearer ${token}`;\n\n          // Validate token against backend to avoid stale sessions\n          try {\n            const res = await api.get(\"/user\");\n            const freshUser = normalizeUser(res.data.user || res.data);\n            if (freshUser) {\n              updateUser(freshUser);\n            } else {\n              throw new Error(\"Invalid user payload\");\n            }\n          } catch (err) {\n            // If backend is down (500) keep the cached user so the UI can still render\n            const parsedUser = normalizeUser(JSON.parse(storedUser));\n            const status = err?.response?.status;\n            console.warn(\"Token validation failed:\", status, err?.message);\n\n            if (status === 401) {\n              // Invalid token ‚Äî clear session\n              localStorage.removeItem(\"user\");\n              localStorage.removeItem(\"token\");\n              delete api.defaults.headers.common[\"Authorization\"];\n              setUser(null);\n            } else {\n              // Keep cached user for non-auth errors (e.g., 500)\n              setUser(parsedUser);\n            }\n          }\n        }\n      } catch (err) {\n        console.warn(\"üö® Corrupted localStorage user:\", err);\n        localStorage.removeItem(\"user\");\n        localStorage.removeItem(\"token\");\n      } finally {\n        setLoading(false);\n      }\n    };\n\n    bootstrapAuth();\n  }, [updateUser]);\n\n  // -------------------------------------------------------\n  //  LOGIN (NOW FETCHES FRESH USER DATA)\n  // -------------------------------------------------------\n  async function login(email, password) {\n    const response = await api.post(\"/login\", { email, password });\n\n    const userData = normalizeUser(response.data.user || response.data.data);\n    const token = response.data.token;\n\n    console.log(\"Login response:\", {\n      user: userData,\n      token: token,\n      role: userData?.role,\n    });\n\n    if (!userData || !token) {\n      throw new Error(\"Invalid login response: missing user or token\");\n    }\n\n    // Ensure role is present\n    if (!userData?.role) {\n      console.warn(\"‚ö†Ô∏è Warning: User role not provided in login response\");\n    }\n\n    // Store in localStorage\n    localStorage.setItem(\"user\", JSON.stringify(userData));\n    localStorage.setItem(\"token\", token);\n\n    // Update state\n    setUser(userData);\n\n    console.log(\"‚úÖ Login successful. User role:\", userData.role);\n    return userData;\n  }\n\n  // -------------------------------------------------------\n  //  LOGOUT\n  // -------------------------------------------------------\n  async function logout() {\n    try {\n      await api.post(\"/logout\");\n    } catch (err) {\n      console.error(\"Logout API call failed:\", err);\n    } finally {\n      localStorage.removeItem(\"user\");\n      localStorage.removeItem(\"token\");\n      setUser(null);\n      console.log(\"‚úÖ Logged out successfully\");\n    }\n  }\n\n  // -------------------------------------------------------\n  //  REFRESH USER DATA FROM BACKEND\n  //  (Used after updating profile)\n  // -------------------------------------------------------\n  async function refreshUser() {\n    try {\n      const token = localStorage.getItem(\"token\");\n      if (!token) return;\n\n      const response = await api.get(\"/user\", {\n        headers: { Authorization: `Bearer ${token}` },\n      });\n\n      updateUser(response.data.user || response.data);\n    } catch (err) {\n      console.warn(\"Failed to refresh user:\", err);\n    }\n  }\n\n  return (\n    <AuthContext.Provider\n      value={{\n        user,\n        setUser: updateUser, // üî• used by Profile.js\n        login,\n        logout,\n        refreshUser, // üî• call this after saving profile\n        loading,\n      }}\n    >\n      {!loading && children}\n    </AuthContext.Provider>\n  );\n}\n\nexport function useAuth() {\n  return useContext(AuthContext);\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}